{"version":3,"sources":["../../../units/urb-base-server/serverGraphQL.js"],"names":["serverGraphQL","use","json","req","res","next","root","objectManager","siteInformation","a_User","User","codeFoundriesInjected","user","schema","rootValue","pretty","graphiql","err","log","status","send","JSON","stringify","error"],"mappings":";;AAEA,yC;AACA,kC;AACA,iD;;AAEA;;AAEA;;;;;AAKA,4B;AACA,sD;AACA;AACA,0C;;;AAGA,8D;;AAEA;AACA,MAAMA,gBAAgB,wBAAtB;;AAEA;AARsC;AAEtC;AAOAA,cAAcC,GAAd,CAAmB,qBAAWC,IAAX,EAAnB,E,CAEA;AACAF,cAAcC,GAAd,CAAmB,CAAEE,GAAF,EAAOC,GAAP,EAAYC,IAAZ;AACjB,gCAAkBF,GAAlB,EAAuBC,GAAvB,EAA4BC,IAA5B,uCADF;;;AAIA,eAAeC,IAAf,CAAqBH,GAArB,EAA0BC,GAA1B,EAA+BC,IAA/B,EAAsC;AACpC,MAAI;AACF,UAAME,gBAAgB,MAAM,qCAAkBJ,GAAlB,EAAuBC,GAAvB,CAA5B;AACA,QAAKG,cAAcC,eAAnB,EAAqC;AACnC,UAAI;AACF,cAAMC,SAAS,CAAE,MAAM;AACrBF,qBADqB;AAErBJ,WAFqB,CAAR;AAGXO,YAHJ;;AAKAN,YAAIO,qBAAJ,GAA4B,EAAEC,MAAMH,MAAR,EAA5B;AACA,cAAM,2CAAqBA,MAArB,EAA6BN,GAA7B,CAAN;;AAEA,sCAAa,MAAM;AACjB,iBAAO;AACLU,oCADK;AAELC,uBAAWP,aAFN;AAGLQ,oBAAQ,IAHH;AAILC,sBAAU,IAJL,EAAP;;AAMD,SAPD,EAOIb,GAPJ,EAOSC,GAPT,EAOcC,IAPd;AAQD,OAjBD,CAiBE,OAAQY,GAAR,EAAc;AACd,yDAA2Bd,GAA3B,EAAgCC,GAAhC,EAAqCa,GAArC,EAA0C,IAA1C;AACD;AACF;AACF,GAxBD,CAwBE,OAAQA,GAAR,EAAc;AACd,kBAAIC,GAAJ,CAAS,OAAT,EAAkB,gBAAlB,EAAoCD,GAApC;AACAb,QAAIe,MAAJ,CAAY,GAAZ,EAAkBC,IAAlB;AACEC,SAAKC,SAAL,CAAe;AACbC,aAAO,mDADM,EAAf,CADF;;;AAKD;AACF;AACDvB,cAAcC,GAAd,CAAmB,GAAnB,EAAwBK,IAAxB,E;;AAEeN,a","file":"serverGraphQL.js","sourcesContent":["// @flow\n\nimport bodyParser from 'body-parser'\nimport express from 'express'\nimport graphQLHTTP from 'express-graphql'\n\nimport { requestLoggerGraphQL } from '../_configuration/urb-base-server/requestLoggers'\n\nimport {\n  getUserAndSessionIDByUserToken1,\n  verifyUserAuthToken,\n  serveAuthenticationFailed,\n} from './checkCredentials'\nimport log from './log'\nimport logServerRequest from './logServerRequest'\nimport { getObjectManager } from './graphql/ObjectManager'\nimport schema from './graphql/schema' // Schema for GraphQL server\n\n// Guarantee that all object registrations and schema definitions are executed\nimport '../_configuration/urb-base-server/graphql/_schemas'\n\n// Create router for GraphQL\nconst serverGraphQL = express()\n\n// Set up parser\nserverGraphQL.use( bodyParser.json() )\n\n// Set up logging\nserverGraphQL.use( ( req, res, next ) =>\n  logServerRequest( req, res, next, requestLoggerGraphQL )\n)\n\nasync function root( req, res, next ) {\n  try {\n    const objectManager = await getObjectManager( req, res )\n    if ( objectManager.siteInformation ) {\n      try {\n        const a_User = ( await getUserAndSessionIDByUserToken1(\n          objectManager,\n          req\n        ) ).User\n\n        res.codeFoundriesInjected = { user: a_User }\n        await verifyUserAuthToken( a_User, req )\n\n        graphQLHTTP( () => {\n          return {\n            schema: schema,\n            rootValue: objectManager,\n            pretty: true,\n            graphiql: true,\n          }\n        })( req, res, next )\n      } catch ( err ) {\n        serveAuthenticationFailed( req, res, err, true )\n      }\n    }\n  } catch ( err ) {\n    log.log( 'error', 'Error: GraphQL', err )\n    res.status( 500 ).send(\n      JSON.stringify({\n        error: 'An error has occurred while running GraphQL query',\n      })\n    )\n  }\n}\nserverGraphQL.use( '/', root )\n\nexport default serverGraphQL\n"]}